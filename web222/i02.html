<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Treasure Hunt</title>
<style>
body, html {
  height: 100%;
  margin: 0;
  overflow: hidden; /* é˜²æ­¢å‡ºç°æ»šåŠ¨æ¡ */
}
#treasure-map {
  
  width: 100%;
  height: auto;
  display: block;
  margin: 0 auto;
}
#clue-image {
  position: absolute;
  bottom: 10px;
  right: 10px;
  width: 50px; /* è®¾ç½®çº¿ç´¢å›¾ç‰‡çš„åˆå§‹å¤§å° */
  cursor: pointer;
  transition: transform 0.5s ease;
  z-index: 2; /* ç¡®ä¿çº¿ç´¢å›¾ç‰‡åœ¨å›¾ä¹¦é¦†å›¾ç‰‡ä¹‹ä¸Š */
}
#clue-image.enlarged {
  transform: translate(-50%, -50%) scale(10); /* æ”¾å¤§çº¿ç´¢å›¾ç‰‡å¹¶ç§»åŠ¨åˆ°å±å¹•ä¸­å¤® */
  top: 50%;
  left: 50%;
}
#clue-text {
  display: none;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80%;
  max-width: 500px;
  background-color: rgba(255, 255, 255, 0.8);
  padding: 10px;
  border-radius: 5px;
  font-size: 1em;
  text-align: center;
  z-index: 3; /* ç¡®ä¿æ–‡å­—åœ¨å›¾ç‰‡ä¹‹ä¸Š */
}
#treasure-chest {
  position: absolute;
  bottom: 10px;
  right: 10px;
  width: 50px; /* è®¾ç½®å®ç®±å›¾ç‰‡çš„åˆå§‹å¤§å° */
  cursor: pointer;
  display: none; /* é»˜è®¤ä¸æ˜¾ç¤º */
  z-index: 2; /* ç¡®ä¿å®ç®±å›¾ç‰‡åœ¨ç¥åº™å›¾ç‰‡ä¹‹ä¸Š */
}
#treasure-chest-button {
  display: none; /* é»˜è®¤ä¸æ˜¾ç¤º */
  position: absolute;
  bottom: 10px;
  right: 10px;
  z-index: 3; /* ç¡®ä¿æŒ‰é’®åœ¨å›¾ç‰‡ä¹‹ä¸Š */
}
#treasure-chest.enlarged {
  transform: translate(-50%, -50%) scale(10); /* æ”¾å¤§å®ç®±å›¾ç‰‡å¹¶ç§»åŠ¨åˆ°å±å¹•ä¸­å¤® */
  top: 50%;
  left: 50%;
  pointer-events: none; /* ç¦ç”¨æ”¾å¤§åçš„ç‚¹å‡»äº‹ä»¶ */
}
#treasure-revealed {
  display: none;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80%;
  max-width: 500px;
  background-color: rgba(255, 255, 255, 0.8);
  padding: 10px;
  border-radius: 5px;
  font-size: 1em;
  text-align: center;
  z-index: 3;
}
#treasure-revealed-button {
  display: none;
  position: absolute;
  top: 60%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 3;
}
#treasure-found {
  display: none;
  width: 100%;
  height: auto;
}
#temple-guard {
    display: none;
    width: 50px;
    position: absolute;
    bottom: 10px;
    right: 10px;
    z-index: 2;
    transition: transform 0.5s ease;
}

#temple-guard.enlarged {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(10);
    width: 50px;
}

#bgm-control {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 100;
    padding: 10px;
    border: none;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    font-size: 20px;
}

/* åœ¨ç°æœ‰æ ·å¼ä¹‹å‰æ·»åŠ  */
#intro-section {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

#intro-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
}

#start-adventure {
    position: relative;
    z-index: 11;
    padding: 15px 30px;
    font-size: 1.2em;
    background: linear-gradient(45deg, #ffd700, #ff8c00);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'YouYuan', fantasy;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

#start-adventure:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    background: linear-gradient(45deg, #ff8c00, #ffd700);
}

.hidden {
    display: none !important;
}

.description-box {
    position: fixed; /* æ”¹ä¸ºfixedä»¥å›ºå®šåœ¨è§†å£ä½ç½® */
    bottom: 20px; /* è·ç¦»åº•éƒ¨20px */
    left: 50%; /* æ°´å¹³å±…ä¸­ */
    transform: translateX(-50%); /* å®Œå–„æ°´å¹³å±…ä¸­ */
    width: 80%; /* è®¾ç½®å®½åº¦ */
    max-width: 600px; /* æœ€å¤§å®½åº¦ */
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    font-size: 16px;
    text-align: center;
    display: none;
    z-index: 4;
    /* æ·»åŠ åŠ¨ç”»æ•ˆæœ */
    transition: opacity 0.3s ease-in-out;
    opacity: 0;
}

.description-box.visible {
    opacity: 1;
}
</style>
</head>
<body>
  <div id="intro-section">
    <img id="intro-image" src="intro-background.png" alt="Adventure Introduction">
    <button id="start-adventure">å¼€å¯æ¢ç´¢ä¹‹æ—…</button>
    <button id="continue-game" style="
    position: relative;
    z-index: 11;
    padding: 15px 30px;
    font-size: 1.2em;
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'YouYuan', fantasy;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    margin-top: 20px;
    display: none;
">ç»§ç»­æ¸¸æˆ</button>
  </div>
  <div id="description" class="description-box"></div>
    <img id="treasure-map" src="library.png" alt="Ancient Library">
    <img id="clue-image" src="1.png" alt="Clue" onclick="onClueImageClick()">
    <div id="clue-text"></div>
    <button id="continue-button" style="display: none; position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); z-index: 3;">
      è§£ç </button>
    <img id="temple-map" src="temple.png" alt="Ancient Temple" style="display: none; width: 100%; height: auto;">
    <img id="treasure-chest" src="box.png" alt="Treasure Chest" onclick="onTreasureChestClick()">
    <div id="treasure-revealed"></div>
    <button id="treasure-revealed-button" style="display: none;">æ‰¾åˆ°å®è—</button>
    <img id="treasure-found" src="treasure.png" alt="Treasure Found" style="display: none;">
    <img id="temple-guard" src="2.png" alt="Temple Guard" style="display: none;">

    <audio id="bgm" loop>
      <source src="background-music.ogg" type="audio/mpeg">
      æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
    </audio>
    <button id="bgm-control">ğŸ”‡</button>

<script>

// æ·»åŠ ç©å®¶ä¿¡æ¯ç®¡ç†ç±»
class PlayerManager {
    constructor() {
        this.player = this.loadPlayer() || null;
    }

     // åˆ›å»ºæ–°ç©å®¶
     createNewPlayer(username, userId) {
        const newPlayer = {
            id: userId,
            username: username,
            createdAt: new Date().toISOString(),
            gameHistory: [],
            lastPlayed: new Date().toISOString(),
            currentState: 'library', // åˆå§‹çŠ¶æ€
            createdAt: new Date().toISOString()
        };
        this.savePlayer(newPlayer);
        return newPlayer;
    }

 // ä¿å­˜æ¸¸æˆçŠ¶æ€ 
 saveGameState(state, details = {}) {
       if (!this.player) return;
       this.player.currentState = state;
       this.player.stateDetails = details;  // æ·»åŠ è¯¦ç»†çŠ¶æ€ä¿¡æ¯
       this.savePlayer(this.player);
   }
     // ä¿å­˜ç©å®¶ä¿¡æ¯åˆ° localStorage
     savePlayer(playerData) {
        localStorage.setItem('treasureHuntPlayer', JSON.stringify(playerData));
    }

   // ä» localStorage åŠ è½½ç©å®¶ä¿¡æ¯
    loadPlayer() {
        const savedPlayer = localStorage.getItem('treasureHuntPlayer');
        return savedPlayer ? JSON.parse(savedPlayer) : null;
    }

    // æ›´æ–°æ¸¸æˆå†å²
    addGameHistory(event) {
      if (!this.player) return;
       if (!this.player.gameHistory) {
           this.player.gameHistory = [];
       }
       this.player.gameHistory.push({
           event: event,
           timestamp: new Date().toISOString()
       });
       this.savePlayer(this.player);
    }

    // æ›´æ–°ç©å®¶æ˜µç§°
    updateNickname(newNickname) {
        this.player.nickname = newNickname;
        this.savePlayer(this.player);
    }

    // è·å–æ¸¸æˆå†å²
    getGameHistory() {
        return this.player.gameHistory;
    }
}

// åˆ›å»ºå…¨å±€ç©å®¶ç®¡ç†å™¨å®ä¾‹
let playerManager;





  class TreasureMap {
    static getInitialClue() {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve("åœ¨å¤è€çš„å›¾ä¹¦é¦†é‡Œæ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªçº¿ç´¢...");
          }, 1000);
        });
      }
    
      static decodeAncientScript(clue) {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            if (!clue) {
              reject("æ²¡æœ‰çº¿ç´¢å¯ä»¥è§£ç !");
            }
            resolve("è§£ç æˆåŠŸ!å®è—åœ¨ä¸€åº§å¤è€çš„ç¥åº™ä¸­...");
          }, 300);
        });
      }
    
      static searchTemple(location) {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            const random = Math.random();
            if (random < 0.5) {
              reject("ç³Ÿç³•!é‡åˆ°äº†ç¥åº™å®ˆå«!");
            }
            resolve("æ‰¾åˆ°äº†ä¸€ä¸ªç¥ç§˜çš„ç®±å­...");
          }, 2000);
        });
      }
    
      static openTreasureBox() {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve("æ­å–œ!ä½ æ‰¾åˆ°äº†ä¼ è¯´ä¸­çš„å®è—!");
          }, 1000);
        });
      }
}

// ä½¿ç”¨async/awaité‡å†™findTreasureå‡½æ•°
async function findTreasureWithAsync() {
   try {
    const initialClue = await TreasureMap.getInitialClue();
    document.getElementById('clue-text').textContent = initialClue;
    document.getElementById('clue-text').style.display = 'block';
    document.getElementById('continue-button').style.display = 'block';
  } catch (error) {
    console.error("ä»»åŠ¡å¤±è´¥:", error);
  }
}

// å…¨å±€å˜é‡å­˜å‚¨æè¿°æ•°æ®
let descriptions = {};

// åŠ è½½æè¿°æ•°æ®
async function loadDescriptions() {
    try {
        const response = await fetch('descriptions.txt');
        if (!response.ok) {
            throw new Error('æ— æ³•åŠ è½½æè¿°æ–‡ä»¶');
        }
        descriptions = await response.json();
    } catch (error) {
        console.error('åŠ è½½æè¿°å¤±è´¥:', error);
    }
}
// æ·»åŠ åœ¨scriptå¼€å¤´
function speakText(text) {
    // åˆ›å»ºè¯­éŸ³åˆæˆå®ä¾‹
    const utterance = new SpeechSynthesisUtterance(text);
    // è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡
    utterance.lang = 'zh-CN';
    // è®¾ç½®è¯­é€Ÿ
    utterance.rate = 0.9;
    // è®¾ç½®éŸ³é‡
    utterance.volume = 1;
    // æ’­æ”¾è¯­éŸ³
    window.speechSynthesis.speak(utterance);
}
// æ˜¾ç¤ºæè¿°
function showDescription(type) {
    const descriptionBox = document.getElementById('description');
    if (descriptions[type]) {
        descriptionBox.textContent = descriptions[type];
        descriptionBox.style.display = 'block';
        // ä½¿ç”¨setTimeoutç¡®ä¿displayæ›´æ”¹åå†æ·»åŠ visibleç±»
        setTimeout(() => {
            descriptionBox.classList.add('visible');
        }, 10);
    }
}


// å¤„ç†å›¾ç‰‡ç‚¹å‡»äº‹ä»¶
function onClueImageClick() {
  const clueImage = document.getElementById('clue-image');
  clueImage.classList.add('enlarged');
  document.getElementById('clue-text').textContent = "åœ¨å¤è€çš„å›¾ä¹¦é¦†é‡Œæ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªçº¿ç´¢";
  document.getElementById('clue-text').style.display = 'block';
  document.getElementById('continue-button').style.display = 'block';
  showDescription('library');
  playerManager.addGameHistory('å‘ç°çº¿ç´¢');
  playerManager.saveGameState('library', {
       clueEnlarged: true,
       textVisible: true,
       continueButtonVisible: true
   });
}

// åœ¨ç°æœ‰ä»£ç ä¹‹å‰æ·»åŠ 
function startAdventure() {
 
  // åˆ›å»ºä¸€ä¸ªæ¨¡æ€å¯¹è¯æ¡†
  const modalDialog = document.createElement('div');
    modalDialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        z-index: 1000;
        width: 350px;
    `;

    // æ·»åŠ å¯¹è¯æ¡†å†…å®¹
    modalDialog.innerHTML = `
        <h2 style="text-align: center; margin-bottom: 25px; color: #333;">åˆ›å»ºä½ çš„è§’è‰²</h2>
        <div style="margin-bottom: 20px;">
            <label for="userInput" style="display: block; margin-bottom: 8px; color: #555;">ç”¨æˆ·å:</label>
            <input type="text" id="userInput" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" style="
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 5px;
                box-sizing: border-box;
                font-size: 16px;
            ">
        </div>
        <div style="margin-bottom: 25px;">
            <label for="idInput" style="display: block; margin-bottom: 8px; color: #555;">ID:</label>
            <input type="text" id="idInput" placeholder="è¯·è¾“å…¥ID" style="
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 5px;
                box-sizing: border-box;
                font-size: 16px;
            ">
        </div>
        <button id="confirmButton" style="
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #ffd700, #ff8c00);
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        ">å¼€å§‹å†’é™©</button>
    `;



    // æ·»åŠ æŒ‰é’®æ‚¬åœæ•ˆæœ
    const confirmButton = modalDialog.querySelector('#confirmButton');
    confirmButton.addEventListener('mouseover', () => {
        confirmButton.style.transform = 'scale(1.05)';
    });
    confirmButton.addEventListener('mouseout', () => {
        confirmButton.style.transform = 'scale(1)';
    });

    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(modalDialog);

    // å¤„ç†ç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    confirmButton.addEventListener('click', () => {
        const username = document.getElementById('userInput').value.trim();
        const userId = document.getElementById('idInput').value.trim();

        // éªŒè¯è¾“å…¥
        if (!username || !userId) {
            alert('è¯·å¡«å†™ç”¨æˆ·åå’ŒIDï¼');
            return;
        }

        // åˆ›å»ºæ–°ç©å®¶
        playerManager = new PlayerManager();
        playerManager.player = playerManager.createNewPlayer(username, userId);

        // ç§»é™¤æ¨¡æ€å¯¹è¯æ¡†
        document.body.removeChild(modalDialog);

        // åˆ›å»ºå¹¶æ˜¾ç¤ºç©å®¶ä¿¡æ¯é¢æ¿
        const playerInfo = document.createElement('div');
        playerInfo.style.cssText = `
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
            font-size: 14px;
            transition: all 0.3s ease;
        `;
        playerInfo.innerHTML = `
            <div style="margin-bottom: 5px;">ç©å®¶ID: ${userId}</div>
            <div>ç”¨æˆ·å: <span id="username">${username}</span></div>
        `;

        document.body.appendChild(playerInfo);

        // éšè—ä»‹ç»é¡µé¢
        const introSection = document.getElementById('intro-section');
        introSection.classList.add('hidden');
 // æ·»åŠ è¿”å›æŒ‰é’®äº‹ä»¶å¤„ç†
 const backButton = document.getElementById('backToIntro');
    if (backButton) {
        backButton.onclick = () => {
            // é‡ç½®ç©å®¶æ•°æ®
            playerManager = new PlayerManager();
            // åˆ·æ–°é¡µé¢
            location.reload();
        };
    }
        // æ˜¾ç¤ºæ¸¸æˆä¸»ç•Œé¢
        const treasureMap = document.getElementById('treasure-map');
        treasureMap.style.display = 'block';

        // æ˜¾ç¤ºçº¿ç´¢å›¾ç‰‡
        const clueImage = document.getElementById('clue-image');
        if (clueImage) {
            clueImage.style.display = 'block';
        }

        // æ˜¾ç¤ºå›¾ä¹¦é¦†æè¿°
        showDescription('library');

        // è®°å½•æ¸¸æˆå¼€å§‹
        playerManager.addGameHistory('å¼€å§‹æ¸¸æˆ');

        console.log('æ¸¸æˆå¼€å§‹:', {
            player: {
                username: username,
                id: userId
            },
            gameState: {
                introHidden: introSection.classList.contains('hidden'),
                mapDisplayed: treasureMap.style.display
            }
        });
    });
}

// å¤„ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
function onContinueButtonClick() {
  document.getElementById('clue-text').style.display = 'none';
  document.getElementById('continue-button').style.display = 'none';
  document.getElementById('clue-image').style.display = 'none';
  document.getElementById('treasure-map').style.display = 'none';
  document.getElementById('temple-map').style.display = 'block';
  document.getElementById('treasure-chest').style.display = 'block';
   // æ˜¾ç¤ºè§£ç æˆåŠŸæ–‡æœ¬
   showDescription('temple'); 
   // æ˜¾ç¤ºè§£ç æˆåŠŸæ–‡æœ¬
   const clueText = document.getElementById('clue-text');
   clueText.textContent = "è§£ç æˆåŠŸï¼å®è—åœ¨ä¸€åº§å¤è€çš„ç¥åº™ä¸­...";
   clueText.style.display = 'block';
   playerManager.addGameHistory('è§£ç çº¿ç´¢');
    // ä¿å­˜çŠ¶æ€ï¼ŒåŒ…æ‹¬è§£ç æ–‡æœ¬
    playerManager.saveGameState('temple', {
       decodedTextVisible: true,
       decodedText: "è§£ç æˆåŠŸï¼å®è—åœ¨ä¸€åº§å¤è€çš„ç¥åº™ä¸­..."
   });
   playerManager.addGameHistory('è§£ç æˆåŠŸï¼Œè¿›å…¥ç¥åº™');
  playerManager.saveGameState('temple');
  // è§£ç çº¿ç´¢å¹¶æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
  TreasureMap.decodeAncientScript("åœ¨å¤è€çš„å›¾ä¹¦é¦†é‡Œæ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªçº¿ç´¢...")
    .then(location => {
      document.getElementById('clue-text').textContent = location;
      document.getElementById('clue-text').style.display = 'block';
    })
    .catch(error => {
      console.error("ä»»åŠ¡å¤±è´¥:", error);
    });
}

function onTreasureChestClick(event) {
  
    document.getElementById('clue-text').style.display = 'none';
    const treasureChest = event.target;
    if (treasureChest.classList.contains('enlarged')) {
        return; // å¦‚æœå®ç®±å·²ç»è¢«æ”¾å¤§ï¼Œä¸è§¦å‘ä»»ä½•äº‹ä»¶
    }
    const random = Math.random();
    if (random <= 0.7) {
        // 70% çš„æ¦‚ç‡æ”¾å¤§å®ç®±åˆ°å±å¹•ä¸­å¤®
        
        document.getElementById('treasure-revealed').textContent = "æ‰¾åˆ°äº†ä¸€ä¸ªç¥ç§˜çš„ç®±å­";
        document.getElementById('treasure-revealed').style.display = 'block';
        document.getElementById('treasure-revealed-button').style.display = 'block';
        treasureChest.classList.add('enlarged');
        document.getElementById('temple-guard').style.display = 'none';  // æ·»åŠ è¿™è¡Œ
        showDescription('box');
        playerManager.addGameHistory('å‘ç°å®ç®±');
        playerManager.saveGameState('temple', {
           chestEnlarged: true,
           revealedTextVisible: true,
           revealedButtonVisible: true,
           hideDecodedText: true ,// æ·»åŠ è¿™è¡Œ
           currentDescription: 'box' 
       });
    } else {
        // 30% çš„æ¦‚ç‡é‡åˆ°ç¥åº™å®ˆå«
        const templeGuard = document.getElementById('temple-guard');
        treasureChest.style.display = 'none';
        document.getElementById('treasure-revealed-button').style.display = 'none';
        showDescription('guard');
        playerManager.addGameHistory('é‡åˆ°å®ˆå«');
        // æ˜¾ç¤ºå®ˆå«å’Œæ–‡æœ¬
        templeGuard.style.display = 'block';
        templeGuard.classList.add('enlarged');
        document.getElementById('treasure-revealed').textContent = "ç³Ÿç³•ï¼Œé‡åˆ°äº†ç¥åº™å®ˆå«";
        document.getElementById('treasure-revealed').style.display = 'block';
        // ä¿å­˜é‡åˆ°å®ˆå«çš„çŠ¶æ€
       playerManager.saveGameState('temple', {
           guardEncounter: true,
           treasureHidden: true,
           guardEnlarged: true,
           revealedTextVisible: true,
           hideDecodedText: true  // æ·»åŠ è¿™è¡Œ
       });
    }
}

// å¤„ç†å®è—æ­ç¤ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
function onTreasureRevealedButtonClick() {
 
  document.getElementById('treasure-chest').style.display = 'none';
    document.getElementById('treasure-chest').classList.remove('enlarged');
  document.getElementById('clue-text').style.display = 'none';
  document.getElementById('treasure-revealed-button').style.display = 'none';
  document.getElementById('temple-map').style.display = 'none';
  document.getElementById('treasure-found').style.display = 'block'; // æ˜¾ç¤ºå®è—å›¾ç‰‡

  // æ˜¾ç¤ºæ‰¾åˆ°å®è—çš„æ–‡æœ¬
  document.getElementById('treasure-revealed').textContent = "æ­å–œä½ æˆåŠŸæ‰¾åˆ°å®è—ï¼";
  document.getElementById('treasure-revealed').style.display = 'block';
  showDescription('treasure');
  playerManager.addGameHistory('æ‰¾åˆ°å®è—');
  playerManager.saveGameState('treasure');
   // æ˜¾ç¤ºè¿”å›æŒ‰é’®å¹¶æ·»åŠ ç‚¹å‡»äº‹ä»¶
   const backButton = document.getElementById('backToIntro');
    backButton.style.display = 'block';
    backButton.onclick = () => {
        // é‡ç½®ç©å®¶æ•°æ®
        playerManager = new PlayerManager();
        // åˆ·æ–°é¡µé¢
        location.reload();
    };
  
}

// é¡µé¢åŠ è½½å®Œæˆåç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
document.addEventListener('DOMContentLoaded', async function() {
  try {
    await loadDescriptions();
     // åˆå§‹åŒ–ç©å®¶ç®¡ç†å™¨
     playerManager = new PlayerManager();
      // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æ¸¸æˆçŠ¶æ€
      const savedPlayer = localStorage.getItem('treasureHuntPlayer');
       const continueButton = document.getElementById('continue-game');
       // å¦‚æœæœ‰ä¿å­˜çš„æ¸¸æˆçŠ¶æ€ï¼Œæ˜¾ç¤ºç»§ç»­æ¸¸æˆæŒ‰é’®
       if (savedPlayer) {
        const playerData = JSON.parse(savedPlayer);
        continueButton.style.display = 'block';
           
           // æ·»åŠ ç»§ç»­æ¸¸æˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
           continueButton.addEventListener('click', () => {
               const playerData = JSON.parse(savedPlayer);
               
               // éšè—ä»‹ç»é¡µé¢
               document.getElementById('intro-section').classList.add('hidden');
                // éšè—æ‰€æœ‰æ¸¸æˆå…ƒç´ 
                document.getElementById('treasure-map').style.display = 'none';
               document.getElementById('clue-image').style.display = 'none';
               document.getElementById('temple-map').style.display = 'none';
               document.getElementById('treasure-chest').style.display = 'none';
               document.getElementById('treasure-found').style.display = 'none';
               document.getElementById('treasure-revealed').style.display = 'none';
               document.getElementById('treasure-revealed-button').style.display = 'none';
               document.getElementById('temple-guard').style.display = 'none';
               document.getElementById('clue-text').style.display = 'none';
               document.getElementById('continue-button').style.display = 'none';
               // æ ¹æ®ä¿å­˜çš„çŠ¶æ€æ¢å¤æ¸¸æˆ
               
               switch(playerData.currentState) {
                   case 'library':
                       document.getElementById('treasure-map').style.display = 'block';
                       document.getElementById('clue-image').style.display = 'block';
                        // æ¢å¤è¯¦ç»†çŠ¶æ€
                        if (playerData.stateDetails) {
                           if (playerData.stateDetails.clueEnlarged) {
                               document.getElementById('clue-image').classList.add('enlarged');
                           }
                           if (playerData.stateDetails.textVisible) {
                               document.getElementById('clue-text').style.display = 'block';
                               document.getElementById('clue-text').textContent = "åœ¨å¤è€çš„å›¾ä¹¦é¦†é‡Œæ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªçº¿ç´¢";
                           }
                           if (playerData.stateDetails.continueButtonVisible) {
                               document.getElementById('continue-button').style.display = 'block';
                           }
                       }
                       showDescription('library');
                       break;
                   case 'temple':
                       document.getElementById('temple-map').style.display = 'block';
                       document.getElementById('treasure-chest').style.display = 'block';
                       
                       // æ¢å¤å®ç®±çš„è¯¦ç»†çŠ¶æ€
                      // å…³é”®ä¿®æ”¹ï¼šæ ¹æ®çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºè§£ç æ–‡æœ¬
                     // æ ¹æ®ä¿å­˜çš„æè¿°ç±»å‹æ˜¾ç¤ºå¯¹åº”å†…å®¹
    // æ ¹æ®ä¿å­˜çš„çŠ¶æ€æ¢å¤æ¸¸æˆ
    if (playerData.currentState === 'temple') {
       // æ˜¾ç¤ºç¥åº™åœºæ™¯
       document.getElementById('temple-map').style.display = 'block';
       
       // æ£€æŸ¥æ˜¯å¦æ˜¯å®ç®±æ”¾å¤§çŠ¶æ€
       if (playerData.stateDetails && playerData.stateDetails.chestEnlarged) {
           // æ˜¾ç¤ºæ”¾å¤§çš„å®ç®±
           document.getElementById('treasure-chest').style.display = 'block';
           document.getElementById('treasure-chest').classList.add('enlarged');
           document.getElementById('treasure-revealed').textContent = "æ‰¾åˆ°äº†ä¸€ä¸ªç¥ç§˜çš„ç®±å­";
           document.getElementById('treasure-revealed').style.display = 'block';
           document.getElementById('treasure-revealed-button').style.display = 'block';
           document.getElementById('temple-guard').style.display = 'none';
           showDescription('box');  // å…³é”®ï¼šæ˜¾ç¤ºboxæè¿°
       } else if (playerData.stateDetails && playerData.stateDetails.guardEncounter) {
           // æ˜¾ç¤ºå®ˆå«çŠ¶æ€
           document.getElementById('treasure-chest').style.display = 'none';
           document.getElementById('temple-guard').style.display = 'block';
           document.getElementById('temple-guard').classList.add('enlarged');
           document.getElementById('treasure-revealed').textContent = "ç³Ÿç³•ï¼Œé‡åˆ°äº†ç¥åº™å®ˆå«";
           document.getElementById('treasure-revealed').style.display = 'block';
           showDescription('guard');
       } else {
           // åˆå§‹ç¥åº™çŠ¶æ€
           document.getElementById('treasure-chest').style.display = 'block';
           const clueText = document.getElementById('clue-text');
           clueText.textContent = "è§£ç æˆåŠŸï¼å®è—åœ¨ä¸€åº§å¤è€çš„ç¥åº™ä¸­...";
           clueText.style.display = 'block';
           showDescription('temple');
       }
   }
   
                     
                       break;
                   case 'treasure':
                       document.getElementById('treasure-found').style.display = 'block';
                       document.getElementById('treasure-revealed').style.display = 'block';
                       document.getElementById('treasure-revealed').textContent = "æ­å–œä½ æˆåŠŸæ‰¾åˆ°å®è—ï¼";
                       showDescription('treasure');
                       break;
               }
               
               // åˆ›å»ºç©å®¶ä¿¡æ¯é¢æ¿
               createPlayerInfoPanel(playerData.username, playerData.id);
                // ç¡®ä¿æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨éƒ½è¢«æ­£ç¡®æ·»åŠ 
               if (playerData.currentState === 'library') {
                   document.getElementById('clue-image').onclick = onClueImageClick;
                   document.getElementById('continue-button').onclick = onContinueButtonClick;
               }  // æ ¹æ®ä¿å­˜çš„çŠ¶æ€æ¢å¤æ¸¸æˆ
               
               if (playerData.currentState === 'temple' && !playerData.stateDetails?.chestEnlarged && !playerData.stateDetails?.guardEncounter) {
       const treasureChest = document.getElementById('treasure-chest');
       treasureChest.onclick = onTreasureChestClick;
   }
           });
           
          }
    document.getElementById('continue-button').addEventListener('click', onContinueButtonClick);
    document.getElementById('treasure-revealed-button').addEventListener('click', onTreasureRevealedButtonClick);
    const treasureChest = document.getElementById('treasure-chest');
    const newTreasureChest = treasureChest.cloneNode(true);
    treasureChest.parentNode.replaceChild(newTreasureChest, treasureChest);
    treasureChest.replaceWith(treasureChest.cloneNode(true));
    document.getElementById('treasure-chest').addEventListener('click', onTreasureChestClick, { once: true });  // once: true ç¡®ä¿åªè§¦å‘ä¸€æ¬¡
    document.getElementById('treasure-revealed-button').addEventListener('click', onTreasureRevealedButtonClick);
    newTreasureChest.addEventListener('click', onTreasureChestClick, { once: true });
    document.getElementById('start-adventure').addEventListener('click', startAdventure);
    
    // åˆå§‹éšè—ä¸»è¦å†…å®¹
    document.getElementById('treasure-map').style.display = 'none';






    const bgm = document.getElementById('bgm');
    const bgmControl = document.getElementById('bgm-control');
    const playBGM = () => {
        bgm.play().then(() => {
            bgmControl.textContent = 'ğŸ”Š';
        }).catch(err => {
            console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', err);
            bgmControl.textContent = 'ğŸ”‡';
        });
    };

    // é¡µé¢åŠ è½½æ—¶å°è¯•æ’­æ”¾
    playBGM();

    // éŸ³ä¹æ§åˆ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    bgmControl.addEventListener('click', () => {
        if (bgm.paused) {
            playBGM();
        } else {
            bgm.pause();
            bgmControl.textContent = 'ğŸ”‡';
        }
    });
  } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
    }
});
// æ·»åŠ åˆ›å»ºç©å®¶ä¿¡æ¯é¢æ¿çš„å‡½æ•°
function createPlayerInfoPanel(username, userId) {
   // åˆ›å»ºç©å®¶ä¿¡æ¯é¢æ¿
   const playerInfo = document.createElement('div');
   playerInfo.style.cssText = `
       position: fixed;
       top: 10px;
       left: 10px;
       background: rgba(255, 255, 255, 0.9);
       padding: 15px;
       border-radius: 8px;
       box-shadow: 0 2px 5px rgba(0,0,0,0.2);
       z-index: 100;
       font-size: 14px;
   `;
   
   playerInfo.innerHTML = `
       <div style="margin-bottom: 5px;">ç©å®¶ID: ${userId}</div>
       <div>ç”¨æˆ·å: ${username}</div>
   `;
   
   document.body.appendChild(playerInfo);}
// æ·»åŠ æŒ‰é’®äº‹ä»¶å¤„ç†ï¼ˆæ”¾åœ¨ DOMContentLoaded äº‹ä»¶ç›‘å¬å™¨ä¸­ï¼‰
document.getElementById('backToIntro').addEventListener('click', () => {
    // æ˜¾ç¤ºä»‹ç»é¡µé¢
    document.getElementById('intro-section').classList.remove('hidden');
    
    // éšè—æ¸¸æˆä¸»ç•Œé¢å…ƒç´ 
    document.getElementById('treasure-map').style.display = 'none';
    document.getElementById('clue-image').style.display = 'none';
    document.getElementById('clue-text').style.display = 'none';
    document.getElementById('continue-button').style.display = 'none';
    document.getElementById('temple-map').style.display = 'none';
    document.getElementById('treasure-chest').style.display = 'none';
    document.getElementById('treasure-revealed').style.display = 'none';
    document.getElementById('treasure-revealed-button').style.display = 'none';
    document.getElementById('treasure-found').style.display = 'none';
    document.getElementById('temple-guard').style.display = 'none';
    
    // é‡ç½®æ¸¸æˆçŠ¶æ€
    const clueImage = document.getElementById('clue-image');
    if (clueImage) {
        clueImage.classList.remove('enlarged');
    }
});


</script>
</body>
</html>
